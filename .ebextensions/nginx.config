files:
  "/tmp/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: | 
        # Elastic Beanstalk Managed

        # Elastic Beanstalk managed configuration file
        # Some configuration of nginx can be by placing files in /etc/nginx/conf.d
        # using Configuration Files.
        # http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers.html 
        # 
        # Modifications of nginx.conf can be performed using container_commands to modify the staged version
        # located in /tmp/deployment/config/etc#nginx#nginx.conf


        upstream nodejs {
            server 127.0.0.1:8081;
            keepalive 256;
        }

        server {
            # set the server_name variable, and turn off the server_tokens
            server_name www.replace-me.com;
            server_tokens off;
            listen 8080;


            if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
                set $year $1;
                set $month $2;
                set $day $3;
                set $hour $4;
            }
            access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
            access_log  /var/log/nginx/access.log  main;

            # reverse proxy /health no matter what ( used by AWS ELB healthCheck/monitoring )
            location /health {
                proxy_pass  http://nodejs;
                proxy_set_header   Connection "";
                proxy_http_version 1.1;
                proxy_set_header        Host            $host;
                proxy_set_header        X-Real-IP       $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            # for everything else, verify the scheme that was reported by the ELB before sending to the backend server
            location / {
                if ($http_x_forwarded_proto != 'https') {
                  return 301 https://$server_name$request_uri;
                }
                proxy_pass  http://nodejs;
                proxy_set_header   Connection "";
                proxy_http_version 1.1;
                proxy_set_header        Host            $host;
                proxy_set_header        X-Real-IP       $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            }

            gzip on;
            gzip_comp_level 4;
            gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        }

container_commands:
  01-replace-default-nginx-config:
    command: mv -f /tmp/proxy.conf /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf
